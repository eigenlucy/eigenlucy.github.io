{% comment %} Original version, assuming this worked before more complex base_path logic {% endcomment %}
{% assign img_path_slug = include.path | remove: '.jpg' | remove: '.jpeg' | remove: '.png' | remove: '.tiff' | remove: '.gif' | remove: '.JPG' | remove: '.JPEG' | remove: '.PNG' %}

<figure
  {% if include.slot %}
    slot="{{ include.slot }}"
  {% endif %}
>
  <picture>
    {% if site.imagemagick.enabled %}
      <source
        class="responsive-img-srcset"
        srcset="{% for i in site.imagemagick.widths %}{{ img_path_slug | relative_url }}-{{ i }}.webp {{i}}w{% unless forloop.last %},{% endunless %}{% endfor %}"
        {% if include.sizes %}
          sizes="{{include.sizes}}"
        {% elsif page.permalink == '/gallery/' %}
          sizes="(min-width: 768px) 22vw, 85vw" {% comment %} For 4-column gallery, assuming max_width 85% {% endcomment %}
        {% else %}
          sizes="95vw"
        {% endif %}
        type="image/webp"
      >
    {% endif %}
    <img
      src="{{ include.path | relative_url }}"      
      {% if include.class %}
        class="{{ include.class }}"
      {% endif %}
      {% if include.width %}
        width="{{ include.width }}"
      {% else %}
        width="100%"
      {% endif %}
      {% if include.height %}
        height="{{ include.height }}"
      {% else %}
        height="auto"
      {% endif %}
      {% if include['min-width'] or include['min-height'] or include['max-width'] or include['max-height'] %}
        style="
          {% if include['min-width'] %}
            min-width: {{ include.min-width }};
          {% endif %}
          {% if include['min-height'] %}
            min-height: {{ include.min-height }};
          {% endif %}
          {% if include['max-width'] %}
            max-width: {{ include.max-width }};
          {% endif %}
          {% if include['max-height'] %}
            max-height: {{ include.max-height }};
          {% endif %}
        "
      {% endif %}
      {% if include.alt %}
        alt="{{ include.alt | escape }}"
      {% else %}
        alt="Gallery Image"
      {% endif %}
      {% if include.title %}
        title="{{ include.title | escape }}"
      {% endif %}
      {% if include.zoomable %}
        data-zoomable
      {% endif %}
      loading="{% if include.loading %}{{ include.loading }}{% elsif site.lazy_loading_images %}lazy{% else %}eager{% endif %}"
      onerror="this.onerror=null; if (this.previousElementSibling && this.previousElementSibling.tagName === 'SOURCE') { this.previousElementSibling.remove(); } this.src='{{ include.path | relative_url }}';"
    >
  </picture>

  {% if include.caption %}
    <figcaption class="caption">{{ include.caption | escape }}</figcaption>
  {% endif %}
</figure>
